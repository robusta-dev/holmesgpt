user_prompt:
- "The payment service in namespace nr-114 is experiencing high latency. Investigate why."

expected_output:
  - The answer must explicitly state that queries that include a promo code are slow or all slow requests include promo code.
  - Including a query that mentions promo code is not sufficient.

tags:
  - kubernetes
  - hard
  - chain-of-causation
  - traces


before_test: |
  [ -n "${NEW_RELIC_ACCOUNT_ID:-}" ] && [ -n "${NEW_RELIC_API_KEY:-}" ] && [ -n "${NEW_RELIC_LICENSE_KEY:-}" ] || { for v in NEW_RELIC_ACCOUNT_ID NEW_RELIC_API_KEY NEW_RELIC_LICENSE_KEY; do [ -n "${!v:-}" ] || echo "Missing env var: $v"; done; exit 1; }
  echo "üöÄ Setting up test 114 - Creating namespace nr-114"
  kubectl create namespace nr-114 || true
  kubectl create secret generic newrelickey --from-literal=key="${NEW_RELIC_LICENSE_KEY}" -n nr-114
  echo "‚úÖ Namespace nr-114 created successfully!"

  echo "üõí Deploying payment service"
  kubectl apply -f payment-service.yaml -n nr-114

  echo "‚è≥ Waiting for payment pod to be ready"
  kubectl wait --for=condition=ready pod -l app=payment -n nr-114 --timeout=60s

  echo "üîç Checking payment deployment status"
  kubectl get pods -n nr-114 -l app=payment

  echo "üö¶ Deploying traffic generator"
  kubectl apply -f traffic-generator.yaml -n nr-114

  echo "‚è≥ Waiting for traffic generator pod to be ready"
  kubectl wait --for=condition=ready pod -l app=traffic-generator -n nr-114 --timeout=60s

  echo "üîç Checking all pods status"
  kubectl get pods -n nr-114

  echo "‚è∞ Letting traffic generator run for 20 seconds to generate requests"
  sleep 20

  echo "üîç Verifying traffic generator log entries"
  if kubectl logs -n nr-114 -l app=traffic-generator --tail=100 | grep -q "WITH promo_code"; then
    echo "‚úÖ Found traffic generator log WITH promo_code"
  else
    echo "‚ùå Missing traffic generator log WITH promo_code"
    exit 1
  fi

  if kubectl logs -n nr-114 -l app=traffic-generator --tail=100 | grep -q "WITHOUT promo_code"; then
    echo "‚úÖ Found traffic generator log WITHOUT promo_code"
  else
    echo "‚ùå Missing traffic generator log WITHOUT promo_code"
    exit 1
  fi

  if kubectl logs -n nr-114 -l app=payment --tail=100 | grep -q "Processing payment request"; then
    echo "‚úÖ Found payment request log"
  else
    echo "‚ùå Missing payment request log"
    exit 1
  fi

  echo "‚úÖ Test setup complete!"

after_test: |
  kubectl delete namespace nr-114 || true
