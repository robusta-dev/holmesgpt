user_prompt: "What is the issue with payment-processing-worker?"
expected_output:
  - The `DEPLOY_ENV` environment variable is undefined or missing
before_test: |
  kubectl create namespace app-09 || true
  cat <<'EOF' | kubectl apply -f -
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    name: payment-processing-worker
    namespace: app-09
  spec:
    replicas: 1
    selector:
      matchLabels:
        app: payment-processing-worker
    template:
      metadata:
        labels:
          app: payment-processing-worker
      spec:
        containers:
        - name: payment-processing-container
          image: busybox:1.36
          command: ["/bin/sh"]
          args: ["-c", "if [ -z \"${DEPLOY_ENV}\" ]; then echo 'Environment variable DEPLOY_ENV is undefined'; exit 1; else while true; do echo hello; sleep 10;done; fi"]
  EOF
  # Wait for pod to exist first with retry loop to handle race condition
  POD_EXISTS=false
  for i in {1..60}; do
    if kubectl get pod -l app=payment-processing-worker -n app-09 2>/dev/null | grep -q payment-processing-worker; then
      echo "✅ Pod exists!"
      POD_EXISTS=true
      break
    else
      echo "⏳ Attempt $i/60: Pod not found yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$POD_EXISTS" = false ]; then
    echo "❌ Pod failed to appear after 300 seconds"
    kubectl get pods -n app-09
    exit 1
  fi

  # Then wait for CrashLoopBackOff
  kubectl wait --for=jsonpath='{.status.containerStatuses[0].state.waiting.reason}'=CrashLoopBackOff pod -l app=payment-processing-worker -n app-09 --timeout=300s || exit 1
after_test: |
  kubectl delete namespace app-09
tags:
  - easy
  - kubernetes
