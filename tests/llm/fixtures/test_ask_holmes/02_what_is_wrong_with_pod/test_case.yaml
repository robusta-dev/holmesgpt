user_prompt: 'What is wrong with << { "type": "pod", "name": "giant-narwhal-6958c5bdd8-69gtn" } >> ?'
expected_output:
  - The pod was killed due to it being out of memory

tags:
  - kubernetes
  - easy

# This test creates a pod that consumes memory until it gets OOMKilled
# Using 'tail /dev/zero' which reads infinite zeros and buffers them in memory
before_test: |
  kubectl create namespace app-02
  cat <<EOF | kubectl apply -f -
  apiVersion: v1
  kind: Pod
  metadata:
    name: giant-narwhal-6958c5bdd8-69gtn
    namespace: app-02
    labels:
      app: ocean-explorer
  spec:
    containers:
    - name: main
      image: busybox:1.35
      command: ["sh", "-c", "tail /dev/zero"]
      resources:
        limits:
          memory: "50Mi"
        requests:
          memory: "50Mi"
  EOF
  # Wait for pod to be created and start running
  kubectl wait --for=condition=Ready pod/giant-narwhal-6958c5bdd8-69gtn -n app-02 --timeout=30s
  # Wait for the pod to be OOMKilled (check every 2 seconds for up to 120 seconds)
  echo "Waiting for pod to be OOMKilled..."
  for i in {1..60}; do
    STATUS=$(kubectl get pod giant-narwhal-6958c5bdd8-69gtn -n app-02 -o jsonpath='{.status.containerStatuses[0].lastState.terminated.reason}' 2>/dev/null || echo "")
    if [ "$STATUS" = "OOMKilled" ]; then
      echo "Pod was OOMKilled successfully"
      break
    fi
    if [ $i -eq 60 ]; then
      echo "Timeout waiting for OOMKill after 120 seconds"
      kubectl describe pod giant-narwhal-6958c5bdd8-69gtn -n app-02
      exit 1
    fi
    sleep 2
  done

after_test: |
  kubectl delete namespace app-02
