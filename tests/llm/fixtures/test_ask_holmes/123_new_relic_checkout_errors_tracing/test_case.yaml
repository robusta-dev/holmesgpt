user_prompt:
- "The billing service in namespace app-123 is experiencing errors. Investigate why."

expected_output:
  - The answer must explicitly state that requests with promo codes are failing or all errors/failures occur when promo code is included.
  - Including a query that mentions promo code is not sufficient.

tags:
  - kubernetes
  - hard
  - chain-of-causation
  - traces
  - newrelic

setup_timeout: 600  # 10 minutes for pod scheduling


before_test: |
  [ -n "${NEW_RELIC_ACCOUNT_ID:-}" ] && [ -n "${NEW_RELIC_API_KEY:-}" ] && [ -n "${NEW_RELIC_LICENSE_KEY:-}" ] || { for v in NEW_RELIC_ACCOUNT_ID NEW_RELIC_API_KEY NEW_RELIC_LICENSE_KEY; do [ -n "${!v:-}" ] || echo "Missing env var: $v"; done; exit 1; }
  echo "üöÄ Setting up test 123 - Creating namespace app-123"
  kubectl create namespace app-123 || true
  kubectl create secret generic newrelickey --from-literal=key="${NEW_RELIC_LICENSE_KEY}" -n app-123
  echo "‚úÖ Namespace app-123 created successfully!"

  echo "üõí Deploying billing service"
  kubectl apply -f billing-service.yaml -n app-123

  echo "‚è≥ Waiting for billing pod to be ready"
  BILLING_POD_READY=false
  for i in {1..60}; do
    if kubectl wait --for=condition=ready pod -l app=billing -n app-123 --timeout=5s 2>/dev/null; then
      echo "‚úÖ Billing pod is ready!"
      BILLING_POD_READY=true
      break
    else
      echo "‚è≥ Attempt $i/60: Billing pod not ready yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$BILLING_POD_READY" = false ]; then
    echo "‚ùå Billing pod failed to become ready after 300 seconds"
    kubectl get pods -n app-123 -l app=billing
    exit 1
  fi

  echo "üîç Checking billing deployment status"
  kubectl get pods -n app-123 -l app=billing

  echo "üö¶ Deploying traffic generator"
  kubectl apply -f traffic-generator.yaml -n app-123

  echo "‚è≥ Waiting for traffic generator pod to be ready"
  TRAFFIC_POD_READY=false
  for i in {1..60}; do
    if kubectl wait --for=condition=ready pod -l app=traffic-generator -n app-123 --timeout=5s 2>/dev/null; then
      echo "‚úÖ Traffic generator pod is ready!"
      TRAFFIC_POD_READY=true
      break
    else
      echo "‚è≥ Attempt $i/60: Traffic generator pod not ready yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$TRAFFIC_POD_READY" = false ]; then
    echo "‚ùå Traffic generator pod failed to become ready after 300 seconds"
    kubectl get pods -n app-123 -l app=traffic-generator
    exit 1
  fi

  echo "üîç Checking all pods status"
  kubectl get pods -n app-123

  echo "‚è∞ Letting traffic generator run for 60 seconds to generate requests"
  sleep 60

  echo "‚úÖ Test setup complete!"

after_test: |
  kubectl delete namespace app-123 || true
