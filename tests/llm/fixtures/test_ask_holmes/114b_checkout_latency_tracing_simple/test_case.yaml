user_prompt:
- "The checkout service in namespace app-114b is experiencing high latency. Investigate why."

expected_output:
  - The answer must explicitly state that queries that include a promo code are slow or all slow requests include promo code.
  - Including a query that mentions promo code is not sufficient.

tags:
  - kubernetes
  - hard
  - chain-of-causation
  - traces

port_forwards:
  - namespace: app-114b
    service: tempo
    local_port: 3215
    remote_port: 3200

before_test: |
  echo "üöÄ Setting up test 114 - Creating namespace app-114b"
  kubectl create namespace app-114b || true
  echo "‚úÖ Namespace app-114b created successfully!"

  echo "üì¶ Deploying Tempo from shared config"
  kubectl apply -f ../../shared/tempo.yaml -n app-114b

  echo "‚è≥ Waiting for Tempo pod to be ready"
  kubectl wait --for=condition=ready pod -l app=tempo -n app-114b --timeout=60s

  echo "‚è∞ Waiting for Tempo to be fully ready (checking every 5s, timeout 60s)"
  TEMPO_READY=false
  for i in {1..12}; do
    if kubectl exec -n app-114b deployment/tempo -- wget -q -O - http://localhost:3200/ready 2>/dev/null; then
      echo "‚úÖ Tempo is ready!"
      TEMPO_READY=true
      break
    else
      echo "‚è≥ Attempt $i/12: Tempo not ready yet, waiting 5s..."
      sleep 5
    fi
  done

  if [ "$TEMPO_READY" = false ]; then
    echo "‚ùå Tempo failed to become ready after 60 seconds"
    exit 1
  fi

  echo "‚úÖ Tempo deployment complete!"

  echo "üõí Deploying checkout service"
  kubectl apply -f checkout-service.yaml -n app-114b

  echo "‚è≥ Waiting for checkout pod to be ready"
  kubectl wait --for=condition=ready pod -l app=checkout -n app-114b --timeout=60s

  echo "üîç Checking checkout deployment status"
  kubectl get pods -n app-114b -l app=checkout

  echo "üö¶ Deploying traffic generator"
  kubectl apply -f traffic-generator.yaml -n app-114b

  echo "‚è≥ Waiting for traffic generator pod to be ready"
  kubectl wait --for=condition=ready pod -l app=traffic-generator -n app-114b --timeout=60s

  echo "üîç Checking all pods status"
  kubectl get pods -n app-114b

  echo "‚è∞ Waiting for traffic generator to produce logs (checking every 3s, timeout 60s)"
  PROMO_LOG_FOUND=false
  for i in {1..20}; do
    if kubectl logs -n app-114b -l app=traffic-generator --tail=100 2>/dev/null | grep -q "WITH promo_code"; then
      echo "‚úÖ Found traffic generator log WITH promo_code after $((i*3)) seconds"
      PROMO_LOG_FOUND=true
      break
    else
      echo "‚è≥ Attempt $i/20: No promo_code log yet, waiting 3s..."
      sleep 3
    fi
  done

  if [ "$PROMO_LOG_FOUND" = false ]; then
    echo "‚ùå Missing traffic generator log WITH promo_code after 60 seconds"
    exit 1
  fi

  if kubectl logs -n app-114b -l app=traffic-generator --tail=100 | grep -q "WITHOUT promo_code"; then
    echo "‚úÖ Found traffic generator log WITHOUT promo_code"
  else
    echo "‚ùå Missing traffic generator log WITHOUT promo_code"
    exit 1
  fi

  if kubectl logs -n app-114b -l app=checkout --tail=100 | grep -q "Processing checkout request"; then
    echo "‚úÖ Found checkout request log"
  else
    echo "‚ùå Missing checkout request log"
    exit 1
  fi

  # Commented out traffic generator trace checks as it no longer sends traces
  # echo "üîç Querying Tempo for traces from traffic generator"
  # TRAFFIC_GEN_TRACES=$(curl -s "http://localhost:3200/api/search?tags=service.name%3Dtraffic-generator&limit=10" 2>/dev/null | grep -o '"traceID"' | wc -l || echo "0")
  # echo "Found $TRAFFIC_GEN_TRACES traces from traffic-generator"

  echo "üîç Querying Tempo for traces from checkout service"
  CHECKOUT_TRACES=$(kubectl run -n app-114b tempo-query --rm -i --restart=Never --image=curlimages/curl -- -s "http://tempo:3200/api/search?tags=service.name%3Dcheckout-service&limit=10" 2>/dev/null | grep -o '"traceID"' | wc -l || echo "0")
  echo "Found $CHECKOUT_TRACES traces from checkout-service"

  # Commented out traffic generator trace check
  # if [ "$TRAFFIC_GEN_TRACES" -gt "0" ]; then
  #   echo "‚úÖ Found traces from traffic-generator"
  # else
  #   echo "‚ùå No traces found from traffic-generator"
  #   exit 1
  # fi

  if [ "$CHECKOUT_TRACES" -gt "0" ]; then
    echo "‚úÖ Found traces from checkout-service"
  else
    echo "‚ùå No traces found from checkout-service"
    exit 1
  fi

  # Delete Traffic generator so the ai won't cheat
  kubectl delete -f traffic-generator.yaml -n app-114b

  echo "‚úÖ Test setup complete!"

after_test: |
  kubectl delete namespace app-114b || true
