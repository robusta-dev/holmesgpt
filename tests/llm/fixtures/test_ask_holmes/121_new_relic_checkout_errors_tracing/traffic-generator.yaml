# ✅ New Relic–only Traffic Generator
# - Traces exported to New Relic OTLP endpoint
# - Logs sent directly to New Relic Logs API with trace/span correlation
# - Mirrors env style used in your other NR manifests

---
apiVersion: v1
kind: Secret
metadata:
  name: traffic-generator-app
type: Opaque
stringData:
  # No telemetry.py needed - traffic generator doesn't need to send logs to New Relic

  app.py: |
    import time
    import random
    import requests
    from datetime import datetime

    CHECKOUT_URL = "http://checkout.app-121.svc.cluster.local:8080/checkout"
    ZONES = ['us-west-1', 'us-west-2', 'us-east-1', 'us-east-2']
    PROMO_CODES = ['SAVE10', 'WELCOME20', 'HOLIDAY15', 'SPECIAL25']

    def generate_traffic():
      """Continuously generate traffic to checkout service"""
      print("[TRAFFIC-GEN] Starting traffic generator", flush=True)
      request_count = 0
      ever_had_promo = False

      while True:
        request_count += 1

        # Force a promo code after 20 requests if we haven't had one yet
        if request_count > 20 and not ever_had_promo:
          include_promo = True
        else:
          include_promo = random.random() < 0.01  # 1% chance

        if include_promo:
          ever_had_promo = True

        # Build request data
        data = {
          "user_id": f"user-{random.randint(1000, 9999)}",
          "zone_id": random.choice(ZONES),
          "items": [
            {
              "id": f"item-{i}",
              "price": round(random.uniform(10, 200), 2),
              "weight": round(random.uniform(0.5, 5.0), 2)
            }
            for i in range(random.randint(1, 3))
          ]
        }

        if include_promo:
          data["promo_code"] = random.choice(PROMO_CODES)

        # Log the request
        promo_status = "WITH" if include_promo else "WITHOUT"
        print(f"[TRAFFIC-GEN] Request #{request_count}: Sending request {promo_status} promo_code", flush=True)

        try:
          start_time = time.time()
          response = requests.post(CHECKOUT_URL, json=data, timeout=10)
          latency = time.time() - start_time

          status = "success" if response.status_code == 200 else f"error({response.status_code})"
          print(f"[TRAFFIC-GEN] Request #{request_count}: Response status={status}, latency={latency:.2f}s", flush=True)

        except Exception as e:
          print(f"[TRAFFIC-GEN] Request #{request_count}: Error - {str(e)}", flush=True)

        # Wait 10ms to 50ms before next request
        time.sleep(random.uniform(0.01, 0.05))

    if __name__ == '__main__':
      print("[TRAFFIC-GEN] Starting...", flush=True)

      # Start generating traffic
      generate_traffic()

  # No requirements.txt needed - using pre-built image with dependencies

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: traffic-generator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: traffic-generator
  template:
    metadata:
      labels:
        app: traffic-generator
    spec:
      containers:
      - name: traffic-generator
        image: me-west1-docker.pkg.dev/robusta-development/development/python-flask-otel:2.1
        command: ["/bin/bash", "-c"]
        args:
        - |
          touch /tmp/ready && \
          python /app/app.py
        volumeMounts:
        - name: app
          mountPath: /app
        env:
        - name: PYTHONUNBUFFERED
          value: "1"
        securityContext:
          capabilities:
            add:
            - SYS_PTRACE
        startupProbe:
          exec:
            command: ["cat", "/tmp/ready"]
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 1
          successThreshold: 1
          failureThreshold: 60
        resources:
          requests:
            memory: "64Mi"
            cpu: "25m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      volumes:
      - name: app
        secret:
          secretName: traffic-generator-app
