# this runs on every commit/PR to test that we are properly building binaries that work
# we test this on each commit/PR to catch build problems early
name: Build and test HolmesGPT

on: [ push, pull_request, workflow_dispatch ]

jobs:
  # Pre-commit checks job
  check:
    name: Pre-commit checks
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        virtualenvs-create: true
        virtualenvs-in-project: true
        virtualenvs-path: .venv
        installer-parallel: true

    - name: Install dependencies
      run: poetry install --no-interaction --no-root

    - uses: pre-commit/action@v3.0.1

  build-and-test:
    needs: check
    if: always() && (needs.check.result == 'success' || needs.check.result == 'skipped')
    uses: ./.github/workflows/build-template.yaml
    with:
      python-versions-matrix: '["3.10", "3.11", "3.12"]'
      os-matrix: '["ubuntu-latest", "windows-latest", "macos-latest"]'
      run-tests: true
      is-release: false
    secrets: inherit
